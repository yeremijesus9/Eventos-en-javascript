<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Creación y Acceso - Eventos</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <!-- Menú superior -->
    <nav>
        <ul>
            <li><a href="index.html">Inicio</a></li>
            <li><a href="tips-de-eventos.html">Tips de Eventos</a></li>
            <li><a href="invocacion-llamada.html">Invocación Llamada</a></li>
            <li><a href="creacion-y-acceso.html" class="active">Creación y Acceso</a></li>
            <li><a href="localstorage.html">LocalStorage</a></li>
        </ul>
    </nav>

    <main>
        <h1>Creación y Acceso — DOM</h1>

        <!-- Parte de la galería -->
        <section class="content-card">
            <h2>Galería dinámica (DOM)</h2>
            <p>Uso createElement, appendChild, parentNode, childNodes, testNode</p>

            <div class="controls">

                <!-- Input para pegar URL -->
                <input id="url-input" type="text" placeholder="Pega URL de imagen">

                <!-- Botón para añadir URL -->
                <button id="btn-add-url" class="demo-button">Añadir URL</button>

                <!-- Botón de imagen aleatoria -->
                <button id="btn-random" class="demo-button">Aleatoria</button>

                <!-- Subir archivo desde PC -->
                <button id="btn-file" class="demo-button">Local</button>

                <!-- Vaciar la galería -->
                <button id="btn-empty" class="demo-button">Vaciar</button>

                <!-- input file oculto -->
                <input id="file-input" type="file" accept="image/*" class="hidden">
            </div>

            <!-- Contenedor general -->
            <div class="demo-area">
                <div id="galeria" class="galeria-grid"></div>
            </div>
        </section>

        <!-- Demo de createTextNode -->
        <section class="content-card">
            <h2>Crear título con createTextNode</h2>

            <button id="btn-create-text" class="demo-button">Crear título</button>

            <div id="text-demo" class="demo-area"></div>
        </section>

        <!-- Registro -->
        <section class="content-card">
            <h2>Registro / Comprobaciones</h2>
            <div id="log"></div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Eventos - Proyecto de Aprendizaje</p>
        <p>Todos los derechos reservados</p>
    </footer>

<script>

    /* Función para escribir mensajes en el registro de abajo */
    function writeLog(...p) {
      const log = document.getElementById("log")
      const line = document.createElement("div")
      line.textContent = p.join(" ")
      log.appendChild(line)
      log.scrollTop = log.scrollHeight
    }

    /* Precargo una imagen para comprobar que funciona antes de añadirla */
    function preloadImage(url, timeout = 6000) {
      return new Promise((resolve, reject) => {

        const img = new Image()
        const timer = setTimeout(() => reject("timeout"), timeout)

        img.onload = () => {
          clearTimeout(timer)
          resolve(url)
        }

        img.onerror = () => {
          clearTimeout(timer)
          reject("error")
        }

        img.src = url
      })
    }

    /* Función para comprobar datos del nodo clicado (tipo, hijos, padre...) */
    function testNode(n) {
      return {
        tipo: n.nodeType,
        etiqueta: n.tagName,
        hijos: n.childNodes.length,
        padre: n.parentNode?.tagName || null
      }
    }

    /* Creo la tarjeta que contiene la imagen y el texto */
    function crearTarjeta(src, caption) {

      const t = document.createElement("div")
      t.className = "tarjeta"

      const img = document.createElement("img")
      img.setAttribute("src", src)

      const p = document.createElement("div")
      p.className = "caption"
      p.textContent = caption

      t.appendChild(img)
      t.appendChild(p)

      /* Si la imagen falla le bajo la opacidad y lo aviso en el caption */
      img.addEventListener("error", () => {
        img.style.opacity = "0.3"
        p.textContent = caption + " (no disponible)"
        writeLog("Imagen rota:", img.getAttribute("src"))
      })

      return t
    }

    /* Inserto una tarjeta en la galería */
    function addToGaleria(node, start = false) {

      const g = document.getElementById("galeria")

      if (start) g.insertBefore(node, g.firstChild)
      else g.appendChild(node)

      writeLog("Añadida:", node.querySelector("img").getAttribute("src"))
    }

    const galeria = document.getElementById("galeria")
    const urlInput = document.getElementById("url-input")

    /* Botón para añadir imagen desde URL */
    document.getElementById("btn-add-url").addEventListener("click", () => {

      const url = urlInput.value.trim()
      if (!url) return writeLog("No hay URL")

      preloadImage(url)
        .then(() => addToGaleria(crearTarjeta(url, "Desde URL")))
        .catch(() => addToGaleria(
          crearTarjeta("https://via.placeholder.com/400x240?text=Error", "No disponible")
        ))
    })

    /* Botón de imagen aleatoria */
    document.getElementById("btn-random").addEventListener("click", () => {

      const src = `https://picsum.photos/seed/${Date.now()}/400/240`

      preloadImage(src)
        .then(valid => addToGaleria(crearTarjeta(valid, "Aleatoria")))
        .catch(() => writeLog("Error al cargar aleatoria"))
    })

    /* Botón para seleccionar archivo */
    document.getElementById("btn-file").addEventListener("click", () => fileInput.click())

    const fileInput = document.getElementById("file-input")

    fileInput.addEventListener("change", (e) => {

      const f = e.target.files[0]
      if (!f) return

      const reader = new FileReader()

      reader.onload = ev => addToGaleria(crearTarjeta(ev.target.result, f.name))

      reader.readAsDataURL(f)
    })

    /* Vaciar toda la galería */
    document.getElementById("btn-empty").addEventListener("click", () => {

      while (galeria.firstChild) galeria.removeChild(galeria.firstChild)
    })

    /* Seleccionar tarjeta al hacer click */
    galeria.addEventListener("click", e => {

      const card = e.target.closest(".tarjeta")
      if (!card) return

      card.classList.toggle("seleccionada")
      writeLog("testNode:", JSON.stringify(testNode(card)))
    })

    /* Borrar tarjeta con doble click */
    galeria.addEventListener("dblclick", e => {

      const card = e.target.closest(".tarjeta")
      if (card) card.parentNode.removeChild(card)
    })

    /* Mover tarjeta al inicio usando Alt + click */
    galeria.addEventListener("mousedown", e => {

      if (!e.altKey) return

      const card = e.target.closest(".tarjeta")
      if (card) galeria.insertBefore(card, galeria.firstChild)
    })

    /* Demo de createTextNode */
    document.getElementById("btn-create-text").addEventListener("click", () => {

      const t = document.createTextNode("Hola Mundo")
      const h = document.createElement("h3")
      h.style.fontSize = "3rem"
      h.style.color = "green"
      h.style.textAlign = "center"
      h.appendChild(t)

      document.getElementById("text-demo").appendChild(h)
    })

    /* Empiezo con dos imágenes de ejemplo */
    addToGaleria(crearTarjeta("https://picsum.photos/seed/1763541415344/400/240", "Ejemplo 1"))
    addToGaleria(crearTarjeta("https://picsum.photos/seed/1763541311995/400/240", "Ejemplo 2"))

</script>

</body>
</html>
